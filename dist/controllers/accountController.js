"use strict";var path=require("path"),captchapng=require("captchapng"),databaseManger=require(path.join(__dirname,"../tools/databaseManger.js"));exports.getLoginPage=function(e,s){s.sendFile(path.join(__dirname,"../views/login.html"))},exports.getVcodeImg=function(e,s){var n=parseInt(9e3*Math.random()+1e3);e.session.vcode=n;var a=new captchapng(80,30,n);a.color(0,0,0,0),a.color(80,80,80,255);var t=a.getBase64(),o=new Buffer(t,"base64");s.writeHead(200,{"Content-Type":"image/png"}),s.end(o)},exports.login=function(e,s){var n={status:0,message:"登录成功"},a=e.body,t=a.username,o=a.password,r=a.vcode;if(e.session.username=t,r!=e.session.vcode)return n.status=1,n.message="验证码错误",void s.json(n);databaseManger.findOne("accountInfo",{username:t,password:o},function(e,a){a||(n.status=2,n.message="用户名或密码错误"),s.json(n)})},exports.getRegisterPage=function(e,s){s.sendFile(path.join(__dirname,"../views/register.html"))},exports.register=function(e,s){var n={status:0,message:"注册成功"};databaseManger.insertOne("accountInfo",e.body,function(e,a){e&&(n.status=1,n.message="注册失败"),s.json(n)})},exports.logout=function(e,s){e.session.username=null,s.send('<script>location.href="/account/login"<\/script>')};